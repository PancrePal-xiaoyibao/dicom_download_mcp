# 下载进度反馈说明

## 功能概述

MCP 服务器现已支持**实时进度反馈**，用户在下载时会看到详细的进度信息，避免感觉"卡住"或"无反应"。

## 进度信息包括

### 下载开始时显示
```
======================================================================
🚀 DICOM 下载开始
======================================================================
📍 下载数量: 2 个URL
📁 输出目录: ./dicom_downloads
⚙️  扫描次数: 3, 帧间延迟: 40ms
⏳ 请稍候，下载中... (可能需要 2-10 分钟)
```

### 下载过程中显示关键进度
```
   >>> 打开检查页面: https://ylyyx.shdc.org.cn/viewer?...
   [1/2] provider=fz
   >>> 已进入 viewer iframe
   >>> provider=fz, mode=all, headless=True
   >>> 共检测到 11 个 series
   === [1/11] series 11：Body 1.0 CE ===
   >> 第 1 轮结束：本轮新增 378，累计 378/387
```

**注意**: 当前版本为文本日志输出,暂不支持可视化进度条。

### 下载完成时显示
```
======================================================================
✅ 下载完成！处理结果中...
======================================================================

✓ https://ylyyx.shdc.org.cn/viewer?share_id=STUDY1
  ✓ 下载成功 (142 个文件)
  
✓ https://zlyy.tjmucih.cn/viewer?share_id=STUDY2
  ✓ 下载成功 (89 个文件)
```

### 下载失败时显示
```
======================================================================
❌ 下载失败
======================================================================
错误信息: Link expired or invalid share code
```

## 进度信息在哪里显示

### 1. 在 MCP Inspector Web UI 中
进度信息会实时更新，显示在工具执行的日志区域。

### 2. 在终端/命令行中
如果你从终端启动 MCP 服务器，会在服务器的标准输出中看到所有进度信息。

### 3. 在 Claude Desktop 中
如果配置了 Claude Desktop 集成，相关进度信息会在 Claude 的对话中显示。

## 进度反馈的内容

### 关键进度指标

| 指标 | 说明 | 何时显示 |
|------|------|---------||
| 下载数量 | 本次操作的 URL 个数 | 下载开始时 |
| 输出目录 | 文件保存位置 | 下载开始时 |
| 扫描参数 | max_rounds 和 step_wait_ms | 下载开始时 |
| 提供者识别 | 检测到的医院类型 (tz/fz/nyfy/cloud) | 下载过程中 |
| series计数 | 检测到的序列数量 | 下载过程中 |
| 轮次进度 | 当前轮次/总轮次，已下载/总数 | 下载过程中 |
| 文件下载数 | 已下载的文件个数 | 完成时 |
| 总耗时 | 下载花费的时间 | 完成时 |

## 预期耗时说明

不同参数组合的预期耗时：

### 快速模式 (max_rounds=2, step_wait_ms=30)
- 小规模 (50 帧): **1-2 分钟**
- 中等规模 (200 帧): **3-5 分钟**
- 大规模 (500+ 帧): **5-10 分钟**

### 平衡模式 (max_rounds=3, step_wait_ms=40) - 推荐
- 小规模 (50 帧): **2-3 分钟**
- 中等规模 (200 帧): **5-8 分钟**
- 大规模 (500+ 帧): **10-15 分钟**

### 完整模式 (max_rounds=5, step_wait_ms=80)
- 小规模 (50 帧): **4-6 分钟**
- 中等规模 (200 帧): **10-15 分钟**
- 大规模 (500+ 帧): **20-30 分钟**

### 深度扫描模式 (max_rounds=10, step_wait_ms=100)
- 小规模 (50 帧): **8-10 分钟**
- 中等规模 (200 帧): **20-25 分钟**
- 大规模 (500+ 帧): **40-60 分钟**

## 进度反馈的实现细节

### 初始化阶段
1. 显示开始横幅，包含基本信息
2. 提示用户可能需要的时间范围
3. 开始启动浏览器自动化

### 执行阶段
1. 实时监听子进程的标准输出
2. 过滤并显示关键进度行（含有特定关键词）
3. 保留完整的日志用于调试

### 完成阶段
1. 显示完成横幅
2. 列出每个 URL 的结果
3. 显示文件计数和成功/失败状态

## 关键词过滤

进度输出中会过滤并显示以下关键词相关的行：
- `下载` - 下载相关操作
- `provider=` - 提供者信息
- `URL` - 当前处理的 URL
- `成功` - 成功标志
- `失败` - 失败标志
- `文件` - 文件计数
- `>>>` - 关键步骤标记
- `###` - URL 处理标记
- `错误` / `Error` - 错误信息
- `WARNING` - 警告信息

## 使用建议

### 对于快速检查
- 使用快速模式参数
- 留意开始和完成的进度横幅
- 不需要逐行查看细节

### 对于重要数据下载
- 使用完整模式或深度扫描模式
- 定期检查进度信息确保没有卡住
- 保存完整的日志用于审计

### 对于批量下载
- 使用平衡模式（推荐）
- 监听关键进度指标
- 每个 URL 都会有单独的结果报告

## 故障排除

### 问题：进度输出过多
**解决**: 这是正常的。关键词过滤已经减少了输出，如需完全静默，可以在下一个版本中添加详细度控制选项。

### 问题：进度输出过少
**解决**: 检查是否：
1. 网络连接不稳定导致卡住
2. 提供者不支持当前医院（查看错误信息）
3. 下载链接已过期

### 问题：进度突然停止
**原因**：可能在处理大量帧，这是正常的。耐心等待，不要中断。

### 问题：看不到任何进度输出
**解决**：
1. 确保在运行 MCP Inspector 或 Claude 的终端中
2. 检查是否已启用输出（某些环境可能禁用输出）
3. 尝试使用 `--verbose` 标志（如果支持）

## 日志保存

如需保存完整的下载日志：

### 在命令行中
```bash
python -m dicom_mcp.server 2>&1 | tee download.log
```

### 在脚本中
```python
import subprocess
with open("download.log", "w") as f:
    subprocess.run(
        ["python", "-m", "dicom_mcp.server"],
        stdout=f,
        stderr=subprocess.STDOUT
    )
```

## 已知限制

1. **可视化进度条**: 当前版本仅支持文本日志输出,暂无可视化进度条 `[███░░]`。由于医院系统的不同实现,无法准确计算总进度百分比。进度反馈基于关键事件，而非精确百分比。

2. **网络波动**: 进度更新取决于网络稳定性。慢速网络可能导致进度更新滞后。

3. **提供者差异**: 不同医院系统的进度信息详尽程度不同。某些提供者会显示更多细节，某些较少。

## 更新日志

### v1.2.7 (2026-01-13)
- ✅ 修复密码自动输入功能
- ✅ 优化虚拟键盘点击逻辑
- ✅ 识别自动提交机制
- 📝 更新文档：明确当前为文本进度输出

### v0.3.0 (2025-01-13)
- ✅ 添加实时进度反馈功能
- ✅ 显示下载开始/进行中/完成横幅
- ✅ 关键词过滤实时输出
- ✅ 预期耗时说明
- ✅ 完整的进度文档

## 建议反馈

如对进度反馈有建议：
- 进度信息太详细/太简洁
- 需要添加其他关键词过滤
- 希望有进度百分比估计
- 需要保存日志的更好方式

欢迎提出改进建议！
